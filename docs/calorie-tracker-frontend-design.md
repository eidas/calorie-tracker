# カロリー管理アプリ「ずぼらカロリー」フロントエンド設計書

## 1. 概要

### 1.1 目的

本設計書は、カロリー管理アプリ「ずぼらカロリー」のフロントエンド部分の詳細設計を定義するものである。ビジネス要件定義書およびシステム要件定義書、バックエンド設計書に基づき、ユーザーインターフェース、画面遷移、コンポーネント構造、状態管理などの技術的詳細を規定する。

### 1.2 スコープ

本設計書は以下の内容を対象とする：

- UI/UXデザイン
- 画面構成と遷移フロー
- コンポーネント設計
- 状態管理設計
- オフライン機能
- データ同期メカニズム
- パフォーマンス最適化
- テスト戦略
- アクセシビリティ対応

### 1.3 設計原則

フロントエンド設計においては、以下の原則を重視する：

1. **シンプルで直感的なUI**：
   - 最小限のタップ数で操作完了
   - 視覚的に分かりやすい情報表示
   - 一貫性のあるデザイン言語

2. **高速なレスポンス**：
   - アプリ起動の迅速化
   - 画面遷移のスムーズさ
   - データ入力の即時反映

3. **オフラインファースト**：
   - インターネット接続なしでの完全機能
   - バックグラウンド同期
   - データ整合性の維持

4. **アクセシビリティ**：
   - 多様なユーザーに対応
   - スクリーンリーダー対応
   - 色覚多様性への配慮

## 2. 技術スタック

### 2.1 フレームワークと言語

- **フロントエンドフレームワーク**: Flutter
- **言語**: Dart
- **スタイリング**: Flutter Material Design
- **状態管理**: Provider/Bloc
- **ナビゲーション**: Flutter Navigator
- **ローカルストレージ**: SQLite
- **グラフ表示**: FL Chart
- **フォーム管理**: Flutter Form widgets
- **バリデーション**: Flutter Validators
- **国際化**: Flutter Intl
- **テスト**: flutter_test, integration_test, flutter_driver

### 2.2 開発ツール

- **パッケージ管理**: pub
- **ビルドツール**: Flutter build
- **コード品質**: dart analyze, dart format
- **型チェック**: Dart
- **CI/CD**: GitHub Actions
- **デバッグ**: Flipper

## 3. アプリケーション構造

### 3.1 ディレクトリ構造

```
lib/
├── main.dart               # エントリーポイント
├── app.dart                # アプリケーションのルートウィジェット
├── assets/                 # 画像、フォント、その他静的リソース
├── config/                 # アプリ設定
├── constants/              # 定数定義
├── data/                   # データレイヤー
│   ├── models/             # データモデル
│   ├── providers/          # データプロバイダー
│   ├── repositories/       # リポジトリ実装
│   └── services/           # APIサービス
├── domain/                 # ドメインレイヤー（ビジネスロジック）
│   ├── entities/           # ビジネスエンティティ
│   ├── repositories/       # リポジトリインターフェース
│   └── usecases/           # ビジネスユースケース
├── l10n/                   # 国際化
├── presentation/           # UIレイヤー
│   ├── pages/              # 完全なページ
│   ├── screens/            # 画面ウィジェット
│   │   ├── auth/           # 認証関連画面
│   │   ├── main/           # メイン画面
│   │   ├── food/           # 食品関連画面
│   │   ├── weight/         # 体重関連画面
│   │   └── settings/       # 設定関連画面
│   ├── widgets/            # 再利用可能なウィジェット
│   │   ├── common/         # 汎用ウィジェット
│   │   ├── food/           # 食品関連ウィジェット
│   │   ├── entry/          # 食事記録関連ウィジェット
│   │   ├── weight/         # 体重関連ウィジェット
│   │   └── stats/          # 統計関連ウィジェット
│   └── blocs/              # 状態管理（Bloc/Provider）
├── routes/                 # ナビゲーション/ルーティング
├── theme/                  # アプリテーマ
├── utils/                  # ユーティリティ関数
└── pubspec.yaml            # 依存関係設定
```

### 3.2 アーキテクチャパターン

本アプリケーションでは、以下のアーキテクチャパターンを採用する：

1. **プレゼンテーションとコンテナの分離**：
   - プレゼンテーションコンポーネント：UI表示のみを担当
   - コンテナコンポーネント：ロジックとデータ管理を担当

2. **Provider/Blocアーキテクチャ**：
   - 単方向データフロー
   - 予測可能な状態管理
   - イベントによる状態変更

3. **リポジトリパターン**：
   - データアクセスの抽象化
   - ローカルデータベース操作の一元管理
   - APIとの連携

4. **サービスレイヤー**：
   - APIとの通信を担当
   - データ変換と正規化
   - エラーハンドリング

### 3.3 ナビゲーション構造

```
AppNavigator
├── AuthNavigator
│   ├── LoginScreen
│   ├── RegisterScreen
│   └── InitialSetupScreen
└── MainNavigator
    ├── TabNavigator
    │   ├── HomeScreen (メイン入力画面)
    │   ├── WeightScreen (体重記録画面)
    │   ├── StatsScreen (統計・分析画面)
    │   └── SettingsScreen (設定画面)
    ├── FoodSearchScreen
    ├── FoodEntryDetailScreen
    ├── CustomFoodFormScreen
    └── DataManagementScreen
```

## 4. UI/UXデザイン

### 4.1 デザインシステム

#### 4.1.1 カラーパレット

- **プライマリカラー**: `#4CAF50` (緑)
- **セカンダリカラー**: `#2196F3` (青)
- **アクセントカラー**: `#FF9800` (オレンジ)
- **背景色**: `#F5F5F5` (ライトグレー)
- **テキスト色**:
  - プライマリ: `#212121` (ダークグレー)
  - セカンダリ: `#757575` (ミディアムグレー)
  - 無効: `#BDBDBD` (ライトグレー)
- **ステータスカラー**:
  - 成功: `#4CAF50` (緑)
  - 警告: `#FFC107` (黄)
  - エラー: `#F44336` (赤)
  - 情報: `#2196F3` (青)

#### 4.1.2 タイポグラフィ

- **フォントファミリー**: 
  - iOS: San Francisco
  - Android: Roboto
  - フォールバック: sans-serif
- **フォントサイズ**:
  - 見出し大: 24sp
  - 見出し中: 20sp
  - 見出し小: 16sp
  - 本文: 14sp
  - キャプション: 12sp
- **フォントウェイト**:
  - 通常: 400
  - 中太: 500
  - 太字: 700

#### 4.1.3 スペーシング

- **基本単位**: 8dp
- **マージン**:
  - 小: 8dp
  - 中: 16dp
  - 大: 24dp
- **パディング**:
  - 小: 8dp
  - 中: 16dp
  - 大: 24dp

#### 4.1.4 コンポーネント

- **ボタン**:
  - プライマリ: 塗りつぶし + プライマリカラー
  - セカンダリ: アウトライン + プライマリカラー
  - テキスト: テキストのみ + プライマリカラー
- **入力フィールド**:
  - アウトラインスタイル
  - フローティングラベル
  - バリデーションメッセージ
- **カード**:
  - 角丸: 8dp
  - 影: 2dp
  - パディング: 16dp
- **リスト**:
  - アイテム高さ: 72dp
  - アイコン: 24dp
  - 区切り線: 1dp, #EEEEEE

### 4.2 画面レイアウト

#### 4.2.1 ホーム画面（メイン入力画面）

- **ヘッダー**:
  - 日付表示（今日の日付、タップで日付選択）
  - 設定ボタン
- **体重入力セクション**:
  - 現在の体重表示
  - 簡易入力フォーム
  - 前回値ワンタップコピー機能
- **カロリーサマリー**:
  - 当日の摂取カロリー合計
  - 目標カロリーとの差分
  - 視覚的なプログレスバー
- **食事記録リスト**:
  - 食事タイプ別セクション（朝食、昼食、夕食、間食）
  - 各食事エントリの表示（食品名、数量、カロリー）
  - クイック追加ボタン
- **クイック入力エリア**:
  - よく使う食品のショートカット
  - 最近の食事記録からのコピー機能
- **フローティングアクションボタン**:
  - 新規食事記録追加

#### 4.2.2 食品検索・選択画面

- **検索バー**:
  - インクリメンタル検索
  - 音声入力オプション
- **カテゴリフィルター**:
  - 主食、おかず、飲み物などのカテゴリタブ
- **検索結果リスト**:
  - 食品名、カロリー情報
  - タップで選択
- **よく使う食品**:
  - 使用頻度の高い食品のクイックアクセス
- **カスタム食品追加**:
  - 新規食品登録ボタン

#### 4.2.3 食事記録詳細画面

- **食品情報**:
  - 食品名
  - カロリー（単位あたり）
- **数量入力**:
  - 数値入力
  - スライダー
- **食事タイプ選択**:
  - 朝食、昼食、夕食、間食のセグメントコントロール
- **日付選択**:
  - カレンダーピッカー
- **メモ入力**:
  - オプショナルなテキスト入力
- **保存/削除ボタン**

#### 4.2.4 体重記録画面

- **体重入力**:
  - 数値入力
  - 前回値表示と簡易コピー機能
- **日付選択**:
  - カレンダーピッカー
- **メモ入力**:
  - オプショナルなテキスト入力
- **体重推移グラフ**:
  - 期間選択（週、月、年）
  - トレンドライン
- **保存ボタン**

### 4.3 画面遷移フロー

```
[スプラッシュ画面] → [ログイン/登録画面] → [初期設定画面]
                                          ↓
[設定画面] ← [ホーム画面(メイン入力)] ↔ [食品検索画面] → [カスタム食品作成]
    ↑           ↑  ↓                      ↓
    |           |  |                      |
    └───────────┘  ↓                      ↓
                [統計画面]           [食事詳細画面]
                    ↑                     ↑
                    |                     |
                    └─────[体重記録画面]──┘
```

## 5. コンポーネント設計

### 5.1 共通コンポーネント

- **Button**: 様々なスタイルとサイズのボタンコンポーネント
- **Input**: テキスト入力フィールドコンポーネント
- **Card**: 情報を表示するカードコンポーネント
- **Modal**: モーダルダイアログコンポーネント
- **Picker**: 選択肢から項目を選ぶピッカーコンポーネント
- **DatePicker**: 日付選択コンポーネント
- **SegmentedControl**: セグメント選択コンポーネント
- **Badge**: ステータスや数値を表示するバッジコンポーネント
- **Icon**: アイコン表示コンポーネント
- **Spinner**: ローディング表示コンポーネント

### 5.2 機能別コンポーネント

- **WeightInput**: 体重入力コンポーネント（前回値コピー機能付き）
- **WeightChart**: 体重推移グラフコンポーネント
- **FoodList**: 食品リスト表示コンポーネント
- **FoodItem**: 食品アイテム表示コンポーネント
- **FoodEntryList**: 食事記録リスト表示コンポーネント
- **FoodEntryItem**: 食事記録アイテム表示コンポーネント
- **CalorieProgress**: カロリー摂取進捗表示コンポーネント
- **MealTypeSelector**: 食事タイプ選択コンポーネント
- **QuantityInput**: 数量入力コンポーネント（スライダー付き）
- **RecentFoodsList**: 最近使用した食品リストコンポーネント
- **FavoriteFoodsList**: お気に入り食品リストコンポーネント

## 6. 状態管理設計

### 6.1 Provider/Bloc構造

```
lib/
├── presentation/
│   └── blocs/              # 状態管理（Bloc）
│       ├── auth/           # 認証状態管理
│       │   ├── auth_bloc.dart
│       │   ├── auth_event.dart
│       │   └── auth_state.dart
│       ├── user/           # ユーザー情報管理
│       ├── food/           # 食品データ管理
│       ├── entry/          # 食事記録管理
│       ├── weight/         # 体重記録管理
│       └── sync/           # 同期状態管理
└── data/
    └── providers/          # データプロバイダー（Provider）
        ├── auth_provider.dart
        ├── user_provider.dart
        ├── food_provider.dart
        ├── entry_provider.dart
        ├── weight_provider.dart
        └── sync_provider.dart
```

### 6.2 主要Bloc/Provider機能

- **AuthBloc/Provider**: ログイン、登録、認証状態管理
- **UserBloc/Provider**: ユーザープロフィール、設定管理
- **FoodBloc/Provider**: 食品データベース、検索、お気に入り管理
- **EntryBloc/Provider**: 食事記録の作成、取得、更新、削除
- **WeightBloc/Provider**: 体重記録の作成、取得、更新、削除
- **SyncBloc/Provider**: オフライン時のデータ同期状態管理

### 6.3 カスタムフック

- **useAuth**: 認証状態と操作を提供
- **useUser**: ユーザー情報と設定を提供
- **useFoods**: 食品データの検索と管理を提供
- **useEntries**: 食事記録の管理を提供
- **useWeightTracking**: 体重記録の管理を提供
- **useSync**: 同期状態と操作を提供
- **useCalorieStats**: カロリー統計情報を提供
- **useWeightStats**: 体重統計情報を提供

## 7. データフロー設計

### 7.1 全体データフロー

```
[ユーザー操作] → [Flutter ウィジェット] → [Bloc イベント] → [Bloc]
                                                          ↓
[UI 更新] ← [Flutter ウィジェット] ← [Bloc 状態] ← [Bloc] ← [リポジトリ]
                                                          ↓
                                                    [サービスレイヤー]
                                                          ↓
                                                    [ローカルDB / API]
```

### 7.2 オフラインファーストアプローチ

1. **ローカルデータベース優先**:
   - すべてのデータはまずローカルデータベース（SQLite）に保存
   - UIはローカルデータベースから直接データを取得・表示
   - ネットワーク接続の有無に関わらず一貫した操作性を提供

2. **同期メカニズム**:
   - ネットワーク接続時にバックグラウンドで自動同期
   - 同期状態の視覚的フィードバック
   - 競合解決戦略の実装

3. **データ整合性**:
   - トランザクション処理によるデータ整合性の確保
   - 同期エラー時のリトライメカニズム
   - データバージョン管理

## 8. オフライン機能

### 8.1 ローカルデータベース設計

#### 8.1.1 SQLiteスキーマ

- **User**: ユーザー情報（ID、名前、メール、身長、目標体重、目標カロリー）
- **Food**: 食品データ（ID、名前、カロリー、単位、カテゴリ、お気に入り状態）
- **FoodEntry**: 食事記録（ID、食品ID、食品名、数量、単位、カロリー、食事タイプ、日付）
- **WeightRecord**: 体重記録（ID、値、日付、メモ）
- **SyncQueue**: 同期キュー（ID、オブジェクトタイプ、オブジェクトID、操作タイプ、データ）

### 8.2 同期メカニズム

- **自動同期**: ネットワーク接続時に自動的に同期
- **手動同期**: ユーザーによる手動同期オプション
- **同期状態表示**: 同期状態の視覚的フィードバック
- **競合解決**: タイムスタンプベースの競合解決戦略
- **リトライメカニズム**: 同期失敗時の指数バックオフリトライ

## 9. パフォーマンス最適化

### 9.1 メモ化

- **const Constructors**: 不変ウィジェットの最適化
- **StatelessWidget**: 状態を持たないウィジェットの使用
- **BuildContext.select**: 必要な状態変更のみを監視

### 9.2 仮想化リスト

- **ListView.builder**: 大量データの効率的な表示
- **ページネーション**: 必要なデータのみの読み込み
- **遅延読み込み**: 画面外のコンテンツの遅延読み込み

### 9.3 画像最適化

- **画像フォーマット**: WebP形式を使用して画像サイズを削減
- **画像サイズ**: 各デバイス解像度に最適化されたサイズを提供
- **遅延読み込み**: 画面外の画像は必要になるまで読み込まない

### 9.4 アプリ起動最適化

- **スプラッシュスクリーン**: Flutter native splash を使用したスプラッシュスクリーン実装
- **初期ロード最適化**: 必要最小限のデータのみを初期ロード時に取得
- **コンパイル最適化**: AOT (Ahead-of-Time) コンパイルによるパフォーマンス向上

## 10. テスト戦略

### 10.1 テスト種別

- **単体テスト**: 個々のウィジェットとサービスのテスト (flutter_test)
- **統合テスト**: 複数のウィジェットの連携テスト (integration_test)
- **E2Eテスト**: ユーザーフローの全体テスト (flutter_driver)

### 10.2 テストカバレッジ目標

- **単体テスト**: コードカバレッジ80%以上
- **統合テスト**: 主要機能フローのカバレッジ70%以上
- **E2Eテスト**: 重要なユーザーストーリーのカバレッジ100%

### 10.3 テスト自動化

- **CI/CD統合**: GitHub Actionsによる自動テスト実行
- **プルリクエストゲート**: テスト成功を必須条件に設定
- **定期的なテスト実行**: 夜間ビルドでの全テスト実行

## 11. アクセシビリティ対応

### 11.1 スクリーンリーダー対応

- **アクセシビリティラベル**: すべての操作要素に適切なラベルを設定
- **アクセシビリティヒント**: 操作の結果を説明するヒントを提供
- **アクセシビリティロール**: 要素の役割を明確に定義
- **アクセシビリティステート**: 要素の状態（無効、選択中など）を提供

### 11.2 色のコントラスト

- **WCAG 2.1 AA基準**に準拠したコントラスト比
- テキストと背景のコントラスト比は最低4.5:1
- 大きなテキストは最低3:1
- UI要素と背景のコントラスト比は最低3:1

### 11.3 タッチターゲットサイズ

- 最小タッチターゲットサイズ: 44×44dp
- タッチ可能な要素間の最小間隔: 8dp
- フォーカス状態の視覚的フィードバック

### 11.4 国際化対応

- 多言語対応（日本語、英語）
- 日付・時刻・数値のローカライズ
- 右から左へ（RTL）のレイアウト対応

## 12. セキュリティ対策

### 12.1 認証・認可

- **JWT認証**: セキュアなトークンベース認証
- **トークン更新**: 自動トークンリフレッシュメカニズム
- **セキュアストレージ**: 認証情報の安全な保存

### 12.2 データ保護

- **ローカルデータ暗号化**: SQLiteデータベースの暗号化
- **通信暗号化**: HTTPS通信の強制
- **機密情報の保護**: APIキーなどの機密情報の安全な管理

## 13. 実装ロードマップ

### 13.1 フェーズ1: 基本機能

- **認証機能**: ログイン、登録、初期設定
- **体重記録**: 体重入力と履歴表示
- **食事記録**: 基本的な食事記録機能
- **オフライン動作**: ローカルデータベース実装

### 13.2 フェーズ2: 拡張機能

- **統計・分析**: グラフ表示と傾向分析
- **食品データベース**: 一般的な食品データの提供
- **カスタム食品**: ユーザー定義食品の作成
- **同期機能**: クラウド同期の実装

### 13.3 フェーズ3: 最適化と拡張

- **パフォーマンス最適化**: レンダリングとデータアクセスの最適化
- **UI/UX改善**: ユーザーフィードバックに基づく改善
- **多言語対応**: 英語など追加言語のサポート
- **プラットフォーム拡張**: Webアプリケーション対応

## 14. まとめ

本設計書では、カロリー管理アプリ「ずぼらカロリー」のフロントエンド部分の詳細設計を定義した。「ずぼらでもカロリー管理できる」というコンセプトに基づき、シンプルで直感的なUI、高速なレスポンス、オフラインファーストなアプローチ、アクセシビリティへの配慮を重視した設計となっている。

FlutterとDartを基盤とし、Provider/Blocによる状態管理、SQLiteによるローカルデータベース、そしてモジュール化されたウィジェット設計により、保守性と拡張性の高いアプリケーションを実現する。

本設計に基づき実装を進めることで、ユーザーにとって使いやすく、継続的に利用できるカロリー管理アプリを提供することが可能となる。
